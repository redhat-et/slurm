# slurm.conf - Slurm configuration file
# Generated by Ansible

ClusterName={{ slurm_cluster_name }}
SlurmctldHost={{ hostvars[groups['slurm_controller'][0]].node_name }}({{ hostvars[groups['slurm_controller'][0]].private_ip }})

# STATE LOCATIONS
StateSaveLocation=/var/spool/slurm/ctld
SlurmdSpoolDir=/var/spool/slurm/d

# LOGGING AND ACCOUNTING
SlurmctldDebug=info
SlurmctldLogFile=/var/log/slurm/slurmctld.log
SlurmdDebug=info
SlurmdLogFile=/var/log/slurm/slurmd.log
JobCompType=jobcomp/none

# TIMERS
SlurmctldTimeout=300
SlurmdTimeout=300
InactiveLimit=0
MinJobAge=300
KillWait=30
Waittime=0

# SCHEDULING
SchedulerType=sched/backfill
SelectType=select/cons_tres
SelectTypeParameters=CR_Core_Memory

# JOB PRIORITY
PriorityType=priority/multifactor
PriorityDecayHalfLife=14-0
PriorityMaxAge=7-0
PriorityWeightAge=1000
PriorityWeightFairshare=10000
PriorityWeightJobSize=1000
PriorityWeightPartition=1000
PriorityWeightQOS=0

# RESOURCE LIMITS
DefMemPerCPU=1024
MaxMemPerCPU=0

# ACCOUNTING
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost={{ hostvars[groups['slurm_controller'][0]].node_name }}
AccountingStoragePort=6819
AccountingStoreFlags=job_comment

# JOB COMPLETION
JobAcctGatherType=jobacct_gather/linux
JobAcctGatherFrequency=30

# PROCESS TRACKING
ProctrackType=proctrack/cgroup
TaskPlugin=task/affinity,task/cgroup

# MPI
MpiDefault=none

# COMPUTE NODES
{% for host in groups['slurm_compute'] %}
NodeName={{ hostvars[host].node_name }} \
    NodeAddr={{ hostvars[host].private_ip }} \
    CPUs=8 \
    RealMemory=30000 \
    Gres=gpu:1 \
    State=UNKNOWN
{% endfor %}

# PARTITIONS
PartitionName=gpu \
    Nodes={{ groups['slurm_compute'] | map('extract', hostvars, 'node_name') | join(',') }} \
    Default=YES \
    MaxTime=INFINITE \
    State=UP \
    OverSubscribe=NO

# GPU SCHEDULING
GresTypes=gpu
